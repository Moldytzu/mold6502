	.include "via2.S"
	LAST_SCANCODE = $05

kbd_init:
	; set VIA2 port A as input
	stz VIA2_DDRA
	stz LAST_SCANCODE
	
	lda #$01
	sta VIA2_PCR
	lda #$82
	sta VIA2_IER
	rts

_irq:
	pha
	phx
	
	ldx VIA2_ORA ; load the scan code
	
	; check last scan code if it's F0 (release)
	lda LAST_SCANCODE
	cmp #$F0
	beq _exit_skip_release
	
	; save last scancode
	stx LAST_SCANCODE
	lda keymap, x
	
	; if it's invalid then exit
	cmp #'?'
	beq _exit_irq
	
	; send to UART and to lcd
	sta ACIA_DATA
	;jsr lcd_write_byte
	
_exit_irq:
	plx
	pla
	rti
	
_exit_skip_release:
	stz LAST_SCANCODE
	plx
	pla
	rti
	
keymap:
  .byte "????????????? `?" ; 00-0F
  .byte "?????q1???zsaw2?" ; 10-1F
  .byte "?cxde43?? vftr5?" ; 20-2F
  .byte "?nbhgy6???mju78?" ; 30-3F
  .byte "?,kio09??./l;p-?" ; 40-4F
  .byte "??'?[=????",$0a,"]?\\??" ; 50-5F
  .byte "?????????1?47???" ; 60-6F
  .byte "0.2568",$1b,"??+3-*9??" ; 70-7F
  .byte "????????????????" ; 80-8F
  .byte "????????????????" ; 90-9F
  .byte "????????????????" ; A0-AF
  .byte "????????????????" ; B0-BF
  .byte "????????????????" ; C0-CF
  .byte "????????????????" ; D0-DF
  .byte "????????????????" ; E0-EF
  .byte "????????????????" ; F0-FF