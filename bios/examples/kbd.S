	.feature STRING_ESCAPES
	.segment "CODE"
	.include "lcd.S"
	.include "utils.S"
	
VIA2_BASE = $8200
VIA2_DDRA = VIA2_BASE + 3
VIA2_DDRB = VIA2_BASE + 2
VIA2_ORA = VIA2_BASE + 1
VIA2_ORB = VIA2_BASE + 0
VIA2_T1CL = VIA2_BASE + 4
VIA2_T1CH = VIA2_BASE + 5
VIA2_PCR = VIA2_BASE + 12
VIA2_ACL = VIA2_BASE + $B
VIA2_IER = VIA2_BASE + $E
VIA2_IFR = VIA2_BASE + $D
	
	LAST_SCANCODE = $05
	
; program entry point
_reset:
	cld ; disable decimal mode
	cli
	
	jsr lcd_init ; initialise the LCD
	lcd_write_string hello_msg ; write a message
	
	; set VIA2 port A as input
	stz VIA2_DDRA
	stz VIA2_DDRB
	stz LAST_SCANCODE
	
	lda #$01
	sta VIA2_PCR
	lda #$82
	sta VIA2_IER
	
	sei
	
	jsr halt
	
_irq:
	lda VIA2_ORA ; read scancode
	
	; translate to a character
	tax
	lda keymap, x
	
	; exit if it's a '?'
	cmp #'?'
	beq exit_irq
	
	; print the character
	jsr lcd_write_byte
	
exit_irq:
	rti
	
keymap:
  .byte "????????????? `?" ; 00-0F
  .byte "?????q1???zsaw2?" ; 10-1F
  .byte "?cxde43?? vftr5?" ; 20-2F
  .byte "?nbhgy6???mju78?" ; 30-3F
  .byte "?,kio09??./l;p-?" ; 40-4F
  .byte "??'?[=????",$0a,"]?\\??" ; 50-5F
  .byte "?????????1?47???" ; 60-6F
  .byte "0.2568",$1b,"??+3-*9??" ; 70-7F
  .byte "????????????????" ; 80-8F
  .byte "????????????????" ; 90-9F
  .byte "????????????????" ; A0-AF
  .byte "????????????????" ; B0-BF
  .byte "????????????????" ; C0-CF
  .byte "????????????????" ; D0-DF
  .byte "????????????????" ; E0-EF
  .byte "????????????????" ; F0-FF
	
irq_msg:
	.asciiz "Q"
	
hello_msg:
	.asciiz "KBD TEST"
	
gata_msg:
	.asciiz "Am gatat"
	
	.segment "RESET_VECTOR"
	.word _irq
	.word _reset
	.word _irq